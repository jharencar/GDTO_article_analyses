---
title: "Palatability_analysis"
format: html
editor: visual
---


### Palatability (removed from final manuscript for low sample size relative to an inability to control for strong variation in beetle hungriness) 
Palatability trials present beetles with a single plant species and measure how much they eat. For palatability trials, we placed a single beetle (previously un-fed for 12 hours) in a ramekin with a 1.5 cm2 square of either C. villosissimus or C. allenii leaf tissue and quantified the leaf area eaten after 12 hours. The variance of leaf area eaten between individual beetles was very high (strong variation in beetle 'hungriness' - some beetles ate a lot, some ate a little). Each beetle was released after one trial, so we were unable to control for beetle hungriness as we did for beetle choice trials. Our sample sizes were therefore too low to detect a difference, if present, in palatability of each species. These analyses were therefore excluded from the manuscript. In 2019, we conducted 24 palatability trials for each plant species.

First, we import, clean, and plot the palatibility data:

```{r}
# importing beetle trial data
btd <- read.csv("data/beetle_trials.csv", header = TRUE) 

## palatability trial data
alleBT <- btd[btd$Species.in.trial =="alle",] # subsetting rows with alle as trial
villBT <- btd[btd$Species.in.trial =="vill",] # subsetting rows with vill as trial
alleBT$alle.mm2eaten <- as.numeric(as.character(alleBT$alle.mm2eaten))
villBT$vill.mm2eaten <- as.numeric(as.character(villBT$vill.mm2eaten))

# Reshaping the dataset
singleSPalle <- data.frame(alleBT$Species.found.on, alleBT$Species.in.trial, alleBT$alle.mm2eaten, alleBT$date)
names(singleSPalle) <- c("species.found.on", "trial.species", "mm2.eaten", "date")
singleSPvill <- data.frame(villBT$Species.found.on, villBT$Species.in.trial, villBT$vill.mm2eaten, villBT$date)
names(singleSPvill) <- c("species.found.on", "trial.species", "mm2.eaten", "date")
singleSP <- rbind(singleSPalle, singleSPvill)
# removing 0s (8 from alle, 9 from vill - common in insect behavior world to get 0s that are thrown out unless different between treatments)
singleSP.no0 <- singleSP[singleSP$mm2.eaten != 0,]

# Box plot of palatability data.
palatability <- ggplot(singleSP.no0, aes(trial.species, mm2.eaten)) + 
  geom_boxplot(outlier.shape=NA, aes(fill = trial.species)) + 
  ggtitle("Palatability Trials") + 
  geom_jitter(alpha=0.6, width=0.15) +
  scale_fill_manual(values = c("#cc79a7", "#FFD700"), name = "Species") +
  guides(fill="none") +
  theme(plot.title = element_text(hjust = 0.5)) +
  ylab('herbivory ('~mm^2*')') + 
  xlab("") +
  coord_cartesian(ylim = c(1, 43)) +
  scale_x_discrete(labels=c("alle" = expression(italic("C. allenii")), 
                            "vill" = expression(italic("C. villosissimus")))) + 
  theme(axis.text.x = element_text(hjust = 0.6, colour = "black")) +
  theme(axis.text = element_text(size = 12))   
palatability
```

Next, we evaluate whether beetles find *C. villosissimus* or *C. allenii* more palatable:

```{r}
# check out the distribution of the data:
hist(singleSP.no0$mm2.eaten, breaks = 50) # clearly not normal

# look at the fit of different distributions using QQ plots
par(mfrow=c(3,1))
qqp(singleSP.no0$mm2.eaten, "norm")
qqp(singleSP.no0$mm2.eaten, "lnorm") # best fit 
MASS::fitdistr(singleSP.no0$mm2.eaten,"Poisson")
qqPlot(singleSP.no0$mm2.eaten, distribution = "pois",lambda = 2) # okay fit 

# regression model - log transformed response and date as a random effect
gBPT  <- lmer(log(singleSP.no0$mm2.eaten) ~ trial.species * (1 | date), data = singleSP.no0)  
summary(gBPT)
Anova(gBPT, type = "III", test.statistic = "F")

# gBPT_link <- glmer(mm2.eaten ~ trial.species + (1 | date), data = singleSP.no0, family = gaussian(link = "log"))
# summary(gBPT_link)
# t.test(singleSP.no0$mm2.eaten ~ singleSP.no0$trial.species)

# evaluating model assumptions
# compare residuals
qqnorm(resid(gBPT)) 
qqline(resid(gBPT))
# not terrible

# qqnorm(resid(gBPT_link)) 
# qqline(resid(gBPT_link))
# # WORSE!

# looking for over/under dispersion
gsimOut <- simulateResiduals(gBPT)
plot(gsimOut) # looks fine
testDispersion(gsimOut) # p-value = 0.928

# gsimOut2 <- simulateResiduals(gBPT_link)
# plot(gsimOut2) # looks fine
# testDispersion(gsimOut2) # 0.976
```



#### NOTES about Choice analysis
# Summary of a bunch of tinkering and my insecurities: log ratio tests suggest that date is not important to include, but it does have biological relvance as shown by the palatability trials, and therefore I think it is important to include. Wilcox test and beta regression with glmmTMB instead of betareg both yeild a p-value around 0.1 rather than 0.01 as in betareg... But Betareg seems both appropriate for the data as I don't think there is strong heteroscedasticity based on the fit of plot(beta) - vertical line, not even sure it is relevant without a response variable...? Plus, betareg uses maximum likelihood rather than a generalization of the Laplace approximation to approximate the likelihood (which is what glmmTMB performs).

```{r}
# # generalize lm with beta family - different way to run beta regression
# library(glmmTMB) 
# beta2 <- glmmTMB(preference_beta ~ (1 | date),
#               data = BCT.no.0, 
#               family=beta_family(link = "logit"))
# summary(beta2)  
# 
# # Check the fit
# plot(beta) # looks fine
# #comparing fits
# lmtest::lrtest(beta, beta2) # one not better than the other
# # check residuals for mod1
# qqnorm(resid(beta)) 
# qqline(resid(beta)) # better
# # check residuals for mod2
# qqnorm(resid(beta2)) 
# qqline(resid(beta2)) # worse
# 
# simOut <- simulateResiduals(beta2)
# plot(simOut) # not great but passes
# testDispersion(simOut) # not great but passes
# 
# # try nonparametric without date 
# wilcox.test(BCT.no.0$preference, mu = 0) # V = 372.5, p-value = 0.1916
```

